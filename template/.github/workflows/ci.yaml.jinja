{% raw %}name: CI

on:
  push:
    branches-ignore:
      - 'gh-readonly-queue/**' # don't run (again) when on these special branches created during merge groups; the `on: merge_group` already triggers it.
  merge_group:

env:
  PYTHONUNBUFFERED: True
  PRE_COMMIT_HOME: ${{ github.workspace }}/.precommit_cache

permissions:
  id-token: write # needed to assume OIDC roles (e.g. for downloading from CodeArtifact)
  contents: read # need to explicitly provide this whenever defining permissions because the default value is 'none' for anything not explicitly set when permissions are defined

jobs:
  get-values:
    uses: ./.github/workflows/get-values.yaml
    permissions:
      contents: write # needed updating dependabot branches

  check-skip-duplicate:
    runs-on: ubuntu-24.04
    steps:
      - id: check
        uses: ./.github/actions/check-skip-duplicates

  lint:
    if: needs.check-skip-duplicate.outputs.should-run == 'true'
    needs: [ get-values, check-skip-duplicate ]
    name: Pre-commit
    uses: ./.github/workflows/pre-commit.yaml
    permissions:
      contents: write # needed for mutex
      id-token: write # needed to assume OIDC roles (e.g. for downloading from CodeArtifact)
    with:
      python-version: {% endraw %}{{ python_version }}{% raw %}

  unit-test:
    if: needs.check-skip-duplicate.outputs.should-run == 'true'
    needs: [ lint, check-skip-duplicate ]
    runs-on: {% endraw %}{{ gha_linux_runner }}{% raw %}
    steps:
      - name: Checkout code
        uses: actions/checkout@{% endraw %}{{ gha_checkout }}{% raw %}

      - name: Install latest versions of python packages
        uses: ./.github/actions/install_deps
        with:
          python-version: {% endraw %}{{ python_version }}{% raw %}

      - name: Unit test
        run: uv run pytest tests/unit --cov-report=xml --durations=5

  iac-management-pulumi:
    if: needs.check-skip-duplicate.outputs.should-run == 'true'
    uses: ./.github/workflows/pulumi-aws.yml
    permissions:
      contents: write # needed for mutex
      id-token: write # needed to assume OIDC roles (e.g. for downloading from CodeArtifact)
      pull-requests: write # needed to post the preview on the PR as a comment
    needs: [ unit-test, check-skip-duplicate ]
    with:
      AWS_REGION: {% endraw %}{{ aws_org_home_region }}{% raw %}
      PULUMI_STACK_NAME: prod
      PYTHON_VERSION: {% endraw %}{{ python_version }}{% raw %}
      DEPLOY_SCRIPT_MODULE_NAME: aws_central_infrastructure.iac_management.lib
      DEPLOY_SCRIPT_NAME: pulumi_deploy
      PULUMI_PREVIEW: true
      PREVIEW_ROLE_NAME: InfraPreview--{% endraw %}{{ repo_name }}{% raw %}
      PULUMI_UP: ${{ github.ref == 'refs/heads/main' }}
      PULUMI_UP_ROLE_NAME: InfraDeploy--{% endraw %}{{ repo_name }}{% raw %}
      AWS_ACCOUNT_ID: "{% endraw %}{{ aws_production_account_id }}{% raw %}"
      SHOW_PREVIEW_COMMENT_ON_PR: ${{ github.event_name == 'pull_request' }}
{% endraw %}{% if manage_github_repos %}{% raw %}
  github-repos-pulumi:
    if: needs.check-skip-duplicate.outputs.should-run == 'true'
    uses: ./.github/workflows/pulumi-aws.yml
    permissions:
      contents: write # needed for mutex
      id-token: write # needed to assume OIDC roles (e.g. for downloading from CodeArtifact)
      pull-requests: write # needed to post the preview on the PR as a comment
    needs: [ unit-test, check-skip-duplicate ]
    with:
      AWS_REGION: {% endraw %}{{ aws_org_home_region }}{% raw %}
      PULUMI_STACK_NAME: prod
      PYTHON_VERSION: {% endraw %}{{ python_version }}{% raw %}
      DEPLOY_SCRIPT_MODULE_NAME: aws_central_infrastructure.github_repos.lib
      DEPLOY_SCRIPT_NAME: pulumi_deploy
      PULUMI_PREVIEW: true
      PREVIEW_ROLE_NAME: InfraPreview--{% endraw %}{{ repo_name }}{% raw %}
      PULUMI_UP: ${{ github.ref == 'refs/heads/main' }}
      PULUMI_UP_ROLE_NAME: InfraDeploy--{% endraw %}{{ repo_name }}{% raw %}
      AWS_ACCOUNT_ID: "{% endraw %}{{ aws_production_account_id }}{% raw %}"
      ADDITIONAL_MUTEX_SUFFIX: github
      SHOW_PREVIEW_COMMENT_ON_PR: ${{ github.event_name == 'pull_request' }}{% endraw %}{% if use_repo_secret_for_github_iac_tokens %}{% raw %}
    secrets:
      iac-github-api-tokens: ${{ secrets.IAC_GITHUB_API_TOKENS }}{% endraw %}{% endif %}{% endif %}{% if manage_okta %}{% raw %}

  okta-pulumi:
    if: needs.check-skip-duplicate.outputs.should-run == 'true'
    uses: ./.github/workflows/pulumi-aws.yml
    permissions:
      contents: write # needed for mutex
      id-token: write # needed to assume OIDC roles (e.g. for downloading from CodeArtifact)
      pull-requests: write # needed to post the preview on the PR as a comment
    needs: [ unit-test, check-skip-duplicate ]
    with:
      AWS_REGION: {% endraw %}{{ aws_org_home_region }}{% raw %}
      PULUMI_STACK_NAME: prod
      PYTHON_VERSION: {% endraw %}{{ python_version }}{% raw %}
      DEPLOY_SCRIPT_MODULE_NAME: aws_central_infrastructure.okta.lib
      DEPLOY_SCRIPT_NAME: pulumi_deploy
      PULUMI_PREVIEW: true
      PREVIEW_ROLE_NAME: InfraPreview--{% endraw %}{{ repo_name }}{% raw %}
      PULUMI_UP: ${{ github.ref == 'refs/heads/main' }}
      PULUMI_UP_ROLE_NAME: InfraDeploy--{% endraw %}{{ repo_name }}{% raw %}
      AWS_ACCOUNT_ID: "{% endraw %}{{ aws_production_account_id }}{% raw %}"
      ADDITIONAL_MUTEX_SUFFIX: okta{% endraw %}{% endif %}{% raw %}
      SHOW_PREVIEW_COMMENT_ON_PR: ${{ github.event_name == 'pull_request' }}

  central-networking-pulumi:
    if: needs.check-skip-duplicate.outputs.should-run == 'true'
    uses: ./.github/workflows/pulumi-aws.yml
    permissions:
      contents: write # needed for mutex
      id-token: write # needed to assume OIDC roles (e.g. for downloading from CodeArtifact)
      pull-requests: write # needed to post the preview on the PR as a comment
    needs: [ iac-management-pulumi, check-skip-duplicate ]
    with:
      AWS_REGION: {% endraw %}{{ aws_org_home_region }}{% raw %}
      PULUMI_STACK_NAME: prod
      PYTHON_VERSION: {% endraw %}{{ python_version }}{% raw %}
      DEPLOY_SCRIPT_MODULE_NAME: aws_central_infrastructure.central_networking.lib
      DEPLOY_SCRIPT_NAME: pulumi_deploy
      PULUMI_PREVIEW: true
      PREVIEW_ROLE_NAME: InfraPreview--{% endraw %}{{ repo_name }}{% raw %}
      PULUMI_UP: ${{ github.ref == 'refs/heads/main' }}
      PULUMI_UP_ROLE_NAME: InfraDeploy--{% endraw %}{{ repo_name }}{% raw %}
      AWS_ACCOUNT_ID: "{% endraw %}{{ aws_production_account_id }}{% raw %}"
      SHOW_PREVIEW_COMMENT_ON_PR: ${{ github.event_name == 'pull_request' }}

  artifact-stores-pulumi:
    if: needs.check-skip-duplicate.outputs.should-run == 'true'
    uses: ./.github/workflows/pulumi-aws.yml
    permissions:
      contents: write # needed for mutex
      id-token: write # needed to assume OIDC roles (e.g. for downloading from CodeArtifact)
      pull-requests: write # needed to post the preview on the PR as a comment
    needs: [ iac-management-pulumi, central-networking-pulumi, check-skip-duplicate ] # spinning up AMI builders depends on central-networking
    with:
      AWS_REGION: {% endraw %}{{ aws_org_home_region }}{% raw %}
      PULUMI_STACK_NAME: prod
      PYTHON_VERSION: {% endraw %}{{ python_version }}{% raw %}
      DEPLOY_SCRIPT_MODULE_NAME: aws_central_infrastructure.artifact_stores.lib
      DEPLOY_SCRIPT_NAME: pulumi_deploy
      PULUMI_PREVIEW: true
      PREVIEW_ROLE_NAME: InfraPreview--{% endraw %}{{ repo_name }}{% raw %}
      PULUMI_UP: ${{ github.ref == 'refs/heads/main' }}
      PULUMI_UP_ROLE_NAME: InfraDeploy--{% endraw %}{{ repo_name }}{% raw %}
      AWS_ACCOUNT_ID: "{% endraw %}{{ aws_production_account_id }}{% raw %}"
      SHOW_PREVIEW_COMMENT_ON_PR: ${{ github.event_name == 'pull_request' }}


{% endraw %}{% if initial_iac_management_deploy_occurred %}{% raw %}  identity-center-pulumi:
    if: needs.check-skip-duplicate.outputs.should-run == 'true'
    uses: ./.github/workflows/pulumi-aws.yml
    permissions:
      contents: write # needed for mutex
      id-token: write # needed to assume OIDC roles (e.g. for downloading from CodeArtifact)
      pull-requests: write # needed to post the preview on the PR as a comment
    needs: [ iac-management-pulumi, artifact-stores-pulumi, check-skip-duplicate ] # Identity Center depends on outputs from the Artifact Stores stack to set up permission sets
    with:
      AWS_REGION: {% endraw %}{{ aws_org_home_region }}{% raw %}
      PULUMI_STACK_NAME: prod
      PYTHON_VERSION: {% endraw %}{{ python_version }}{% raw %}
      DEPLOY_SCRIPT_MODULE_NAME: aws_central_infrastructure.identity_center.lib
      DEPLOY_SCRIPT_NAME: pulumi_deploy
      PULUMI_PREVIEW: true
      PREVIEW_ROLE_NAME: InfraPreview--{% endraw %}{{ repo_name }}{% raw %}--identity-center
      PULUMI_UP: ${{ github.ref == 'refs/heads/main' }}
      PULUMI_UP_ROLE_NAME: InfraDeploy--{% endraw %}{{ repo_name }}{% raw %}--identity-center
      AWS_ACCOUNT_ID: "{% endraw %}{{ identity_center_production_account_id }}{% raw %}"{% endraw %}{% endif %}{% raw %}
      SHOW_PREVIEW_COMMENT_ON_PR: ${{ github.event_name == 'pull_request' }}

  required-check:
    runs-on: {% endraw %}{{ gha_linux_runner }}{% raw %}
    permissions:
      statuses: write # needed for updating status on Dependabot PRs
    needs:
      - get-values
      - check-skip-duplicate
      - iac-management-pulumi
      - artifact-stores-pulumi
      - central-networking-pulumi{% endraw %}{% if initial_iac_management_deploy_occurred %}{% raw %}
      - identity-center-pulumi{% endraw %}{% endif %}{% if manage_github_repos %}{% raw %}
      - github-repos-pulumi{% endraw %}{% endif %}{% if manage_okta %}{% raw %}
      - okta-pulumi{% endraw %}{% endif %}{% raw %}
    if: always()
    steps:
      - name: fail if prior job failure
        run: |
          failure_pattern="^(failure|cancelled)$"

          if [[ "${{ needs.check-skip-duplicate.result }}" =~ $failure_pattern ]] ||
             [[ "${{ needs.iac-management-pulumi.result }}" =~ $failure_pattern ]] ||
             [[ "${{ needs.artifact-stores-pulumi.result }}" =~ $failure_pattern ]] ||
             [[ "${{ needs.central-networking-pulumi.result }}" =~ $failure_pattern ]] ||
             [[ "${{ needs.identity-center-pulumi.result }}" =~ $failure_pattern ]] ||
             [[ "${{ needs.github-repos-pulumi.result }}" =~ $failure_pattern ]] ||
             [[ "${{ needs.okta-pulumi.result }}" =~ $failure_pattern ]]; then
            echo "❌ One or more jobs failed or were cancelled"
            exit 1
          fi
          echo "✅ All jobs completed successfully or were skipped"
      - name: Mark updated Dependabot commit of devcontainer hash as succeeded
        if: needs.get-values.outputs.dependabot-commit-created == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh api \
            -X POST -H "Accept: application/vnd.github.v3+json" \
            "/repos/${{ github.repository }}/statuses/${{ needs.get-values.outputs.new-dependabot-sha }}" \
            -f state=success -f context="required-check" -f description="Initial CI run passed" \
            -f target_url="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"{% endraw %}
